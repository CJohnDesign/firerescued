{% extends "layout.html" %}

{% block content %}
<div class="dashboard-container">
    <!-- Top Navigation Bar with Date Selector -->
    <div class="date-nav-bar mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div class="nav-date-controls">
                {% if has_prev %}
                <a href="{{ url_for('core.dashboard', selected_date=prev_date) }}" class="btn btn-icon btn-light">
                    <i class="fas fa-chevron-left"></i>
                </a>
                {% else %}
                <button class="btn btn-icon btn-light" disabled>
                    <i class="fas fa-chevron-left"></i>
                </button>
                {% endif %}
                
                <div class="date-picker-wrapper mx-2">
                    <button id="date-picker-toggle" class="btn btn-outline-primary date-selector-btn">
                        <i class="fas fa-calendar-alt me-2"></i>
                        <span id="current-date-display">
                            {% if selected_date is string %}
                                {{ selected_date }}
                            {% else %}
                                {{ selected_date.strftime('%b %d, %Y') }}
                            {% endif %}
                        </span>
                        <i class="fas fa-caret-down ms-2"></i>
                    </button>
                    
                    <!-- Calendar Popup (Hidden by Default) -->
                    <div id="custom-calendar" class="custom-calendar-popup">
                        <div class="calendar-header">
                            <button id="prev-month" class="calendar-nav-btn"><i class="fas fa-chevron-left"></i></button>
                            <div id="month-year-display"></div>
                            <button id="next-month" class="calendar-nav-btn"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <div class="calendar-weekdays">
                            <div>Su</div><div>Mo</div><div>Tu</div><div>We</div><div>Th</div><div>Fr</div><div>Sa</div>
                        </div>
                        <div id="calendar-days" class="calendar-days"></div>
                        <div class="calendar-footer">
                            <div class="calendar-legend">
                                <span class="legend-item"><span class="dot dot-green"></span> Low Risk</span>
                                <span class="legend-item"><span class="dot dot-yellow"></span> Medium Risk</span>
                                <span class="legend-item"><span class="dot dot-red"></span> High Risk</span>
                                <span class="legend-item"><span class="dot dot-gray"></span> No Data</span>
                            </div>
                            <button id="go-to-today" class="btn btn-sm btn-outline-primary">Today</button>
                        </div>
                    </div>
                </div>
                
                {% if has_next %}
                <a href="{{ url_for('core.dashboard', selected_date=next_date) }}" class="btn btn-icon btn-light">
                    <i class="fas fa-chevron-right"></i>
                </a>
                {% else %}
                <button class="btn btn-icon btn-light" disabled>
                    <i class="fas fa-chevron-right"></i>
                </button>
                {% endif %}
                
                <a href="{{ url_for('core.dashboard') }}" class="btn btn-light ms-2">
                    <i class="fas fa-calendar-day me-1"></i> Today
                </a>
            </div>
            
            <!-- Right-side Actions -->
            <div class="nav-actions">
                {% if selected_record is mapping and selected_record.get('mood_rating') is not none or not selected_record is mapping and selected_record.mood_rating is not none %}
                <div class="btn-group">
                    <a href="{{ url_for('core.input_mood', input_date=selected_date.strftime('%Y-%m-%d') if not selected_date is string else selected_date) }}" 
                       class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-edit me-1"></i> Update Mood
                    </a>
                </div>
                {% else %}
                <a href="{{ url_for('core.input_mood', input_date=selected_date.strftime('%Y-%m-%d') if not selected_date is string else selected_date) }}" 
                   class="btn btn-primary btn-sm">
                    <i class="fas fa-plus-circle me-1"></i> Add Mood
                </a>
                {% endif %}
                
                <a href="{{ url_for('core.settings') }}" class="btn btn-light btn-sm ms-2">
                    <i class="fas fa-cog"></i>
                </a>
            </div>
        </div>
    </div>

    {% if selected_record %}
    <!-- Main Dashboard Content -->
    <div class="row g-4">
        <!-- Left Column - Key Metrics -->
        <div class="col-lg-7">
            <!-- Primary Metrics -->
            <div class="metrics-grid mb-4">
                <!-- Recovery Score -->
                <div class="metric-card primary-metric" 
                    {% if selected_record is mapping %}
                        {% if selected_record.get('recovery_score') is not none and selected_record.get('recovery_score') > 66 %}
                            style="--metric-color: var(--bs-success);"
                        {% elif selected_record.get('recovery_score') is not none and selected_record.get('recovery_score') > 33 %}
                            style="--metric-color: var(--bs-warning);"
                        {% elif selected_record.get('recovery_score') is not none %}
                            style="--metric-color: var(--bs-danger);"
                        {% endif %}
                    {% else %}
                        {% if selected_record.recovery_score is not none and selected_record.recovery_score > 66 %}
                            style="--metric-color: var(--bs-success);"
                        {% elif selected_record.recovery_score is not none and selected_record.recovery_score > 33 %}
                            style="--metric-color: var(--bs-warning);"
                        {% elif selected_record.recovery_score is not none %}
                            style="--metric-color: var(--bs-danger);"
                        {% endif %}
                    {% endif %}
                >
                    <div class="metric-header">
                        <div class="metric-icon">
                            <i class="fas fa-heartbeat"></i>
                        </div>
                        <h3>Recovery</h3>
                    </div>
                    
                    <div class="metric-value">
                        {% if selected_record is mapping %}
                            {{ selected_record.get('recovery_score')|round(1) if selected_record.get('recovery_score') is not none else "–" }}
                        {% else %}
                            {{ selected_record.recovery_score|round(1) if selected_record.recovery_score is not none else "–" }}
                        {% endif %}
                    </div>
                    
                    <div class="metric-label">
                        {% if selected_record is mapping %}
                            {% if selected_record.get('recovery_score') is not none and selected_record.get('recovery_score') > 66 %}
                                <span class="status-pill status-positive">Excellent</span>
                            {% elif selected_record.get('recovery_score') is not none and selected_record.get('recovery_score') > 33 %}
                                <span class="status-pill status-neutral">Moderate</span>
                            {% elif selected_record.get('recovery_score') is not none %}
                                <span class="status-pill status-negative">Low</span>
                            {% endif %}
                        {% else %}
                            {% if selected_record.recovery_score is not none and selected_record.recovery_score > 66 %}
                                <span class="status-pill status-positive">Excellent</span>
                            {% elif selected_record.recovery_score is not none and selected_record.recovery_score > 33 %}
                                <span class="status-pill status-neutral">Moderate</span>
                            {% elif selected_record.recovery_score is not none %}
                                <span class="status-pill status-negative">Low</span>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
                
                <!-- Mood Rating -->
                <div class="metric-card primary-metric" 
                    {% if selected_record is mapping %}
                        {% if selected_record.get('mood_rating') is not none and selected_record.get('mood_rating') > 6 %}
                            style="--metric-color: var(--bs-success);"
                        {% elif selected_record.get('mood_rating') is not none and selected_record.get('mood_rating') > 3 %}
                            style="--metric-color: var(--bs-warning);"
                        {% elif selected_record.get('mood_rating') is not none %}
                            style="--metric-color: var(--bs-danger);"
                        {% endif %}
                    {% else %}
                        {% if selected_record.mood_rating is not none and selected_record.mood_rating > 6 %}
                            style="--metric-color: var(--bs-success);"
                        {% elif selected_record.mood_rating is not none and selected_record.mood_rating > 3 %}
                            style="--metric-color: var(--bs-warning);"
                        {% elif selected_record.mood_rating is not none %}
                            style="--metric-color: var(--bs-danger);"
                        {% endif %}
                    {% endif %}
                >
                    <div class="metric-header">
                        <div class="metric-icon">
                            <i class="fas fa-smile"></i>
                        </div>
                        <h3>Mood</h3>
                    </div>
                    
                    <div class="metric-value">
                        {% if selected_record is mapping %}
                            {% if selected_record.get('mood_rating') is not none %}
                                {{ selected_record.get('mood_rating') }}<span class="metric-unit">/10</span>
                            {% else %}
                                <a href="{{ url_for('core.input_mood', input_date=selected_date.strftime('%Y-%m-%d') if not selected_date is string else selected_date) }}" 
                                   class="btn btn-primary btn-sm add-mood-btn">
                                    <i class="fas fa-plus me-1"></i> Add
                                </a>
                            {% endif %}
                        {% else %}
                            {% if selected_record.mood_rating is not none %}
                                {{ selected_record.mood_rating }}<span class="metric-unit">/10</span>
                            {% else %}
                                <a href="{{ url_for('core.input_mood', input_date=selected_date.strftime('%Y-%m-%d') if not selected_date is string else selected_date) }}" 
                                   class="btn btn-primary btn-sm add-mood-btn">
                                    <i class="fas fa-plus me-1"></i> Add
                                </a>
                            {% endif %}
                        {% endif %}
                    </div>
                    
                    <div class="metric-label">
                        {% if selected_record is mapping %}
                            {% if selected_record.get('mood_rating') is not none and selected_record.get('mood_rating') > 6 %}
                                <span class="status-pill status-positive">Good</span>
                            {% elif selected_record.get('mood_rating') is not none and selected_record.get('mood_rating') > 3 %}
                                <span class="status-pill status-neutral">Neutral</span>
                            {% elif selected_record.get('mood_rating') is not none %}
                                <span class="status-pill status-negative">Poor</span>
                            {% endif %}
                        {% else %}
                            {% if selected_record.mood_rating is not none and selected_record.mood_rating > 6 %}
                                <span class="status-pill status-positive">Good</span>
                            {% elif selected_record.mood_rating is not none and selected_record.mood_rating > 3 %}
                                <span class="status-pill status-neutral">Neutral</span>
                            {% elif selected_record.mood_rating is not none %}
                                <span class="status-pill status-negative">Poor</span>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
                
                <!-- Daily Strain -->
                <div class="metric-card primary-metric" 
                    {% if selected_record is mapping %}
                        {% if selected_record.get('strain') is not none and selected_record.get('strain') < 9 %}
                            style="--metric-color: var(--bs-success);"
                        {% elif selected_record.get('strain') is not none and selected_record.get('strain') < 14 %}
                            style="--metric-color: var(--bs-warning);"
                        {% elif selected_record.get('strain') is not none %}
                            style="--metric-color: var(--bs-danger);"
                        {% endif %}
                    {% else %}
                        {% if selected_record.strain is not none and selected_record.strain < 9 %}
                            style="--metric-color: var(--bs-success);"
                        {% elif selected_record.strain is not none and selected_record.strain < 14 %}
                            style="--metric-color: var(--bs-warning);"
                        {% elif selected_record.strain is not none %}
                            style="--metric-color: var(--bs-danger);"
                        {% endif %}
                    {% endif %}
                >
                    <div class="metric-header">
                        <div class="metric-icon">
                            <i class="fas fa-running"></i>
                        </div>
                        <h3>Strain</h3>
                    </div>
                    
                    <div class="metric-value">
                        {% if selected_record is mapping %}
                            {{ selected_record.get('strain')|round(1) if selected_record.get('strain') is not none else "–" }}<span class="metric-unit">/21</span>
                        {% else %}
                            {{ selected_record.strain|round(1) if selected_record.strain is not none else "–" }}<span class="metric-unit">/21</span>
                        {% endif %}
                    </div>
                    
                    <div class="metric-label">
                        {% if selected_record is mapping %}
                            {% if selected_record.get('strain') is not none and selected_record.get('strain') < 9 %}
                                <span class="status-pill status-positive">Light</span>
                            {% elif selected_record.get('strain') is not none and selected_record.get('strain') < 14 %}
                                <span class="status-pill status-neutral">Moderate</span>
                            {% elif selected_record.get('strain') is not none and selected_record.get('strain') < 18 %}
                                <span class="status-pill status-negative">High</span>
                            {% elif selected_record.get('strain') is not none %}
                                <span class="status-pill status-critical">Extreme</span>
                            {% endif %}
                        {% else %}
                            {% if selected_record.strain is not none and selected_record.strain < 9 %}
                                <span class="status-pill status-positive">Light</span>
                            {% elif selected_record.strain is not none and selected_record.strain < 14 %}
                                <span class="status-pill status-neutral">Moderate</span>
                            {% elif selected_record.strain is not none and selected_record.strain < 18 %}
                                <span class="status-pill status-negative">High</span>
                            {% elif selected_record.strain is not none %}
                                <span class="status-pill status-critical">Extreme</span>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Secondary Metrics Row -->
            <div class="metrics-secondary mb-4">
                <!-- HRV -->
                <div class="secondary-metric">
                    <div class="sm-label">HRV</div>
                    <div class="sm-value">
                        {% if selected_record is mapping %}
                            {{ selected_record.get('hrv')|round(1) if selected_record.get('hrv') is not none else "–" }}
                            {% if selected_record.get('hrv') is not none %}<span class="sm-unit">ms</span>{% endif %}
                        {% else %}
                            {{ selected_record.hrv|round(1) if selected_record.hrv is not none else "–" }}
                            {% if selected_record.hrv is not none %}<span class="sm-unit">ms</span>{% endif %}
                        {% endif %}
                    </div>
                </div>
                
                <!-- Resting HR -->
                <div class="secondary-metric">
                    <div class="sm-label">Resting HR</div>
                    <div class="sm-value">
                        {% if selected_record is mapping %}
                            {{ selected_record.get('resting_hr')|round if selected_record.get('resting_hr') is not none else "–" }}
                            {% if selected_record.get('resting_hr') is not none %}<span class="sm-unit">bpm</span>{% endif %}
                        {% else %}
                            {{ selected_record.resting_hr|round if selected_record.resting_hr is not none else "–" }}
                            {% if selected_record.resting_hr is not none %}<span class="sm-unit">bpm</span>{% endif %}
                        {% endif %}
                    </div>
                </div>
                
                <!-- Sleep Quality -->
                <div class="secondary-metric">
                    <div class="sm-label">Sleep Quality</div>
                    <div class="sm-value">
                        {% if selected_record is mapping %}
                            {{ selected_record.get('sleep_quality')|round if selected_record.get('sleep_quality') is not none else "–" }}
                            {% if selected_record.get('sleep_quality') is not none %}<span class="sm-unit">%</span>{% endif %}
                        {% else %}
                            {{ selected_record.sleep_quality|round if selected_record.sleep_quality is not none else "–" }}
                            {% if selected_record.sleep_quality is not none %}<span class="sm-unit">%</span>{% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Apple-style Metrics Visualization -->
            <div class="dashboard-chart mb-4">
                <div class="apple-chart-header">
                    <div class="apple-chart-title">
                        <h2>Health Metrics</h2>
                        <p class="apple-chart-subtitle">Tracking your key wellness indicators</p>
                    </div>
                    <div class="apple-chart-actions">
                        <div class="chart-period-selector">
                            <button class="chart-period-option active" data-days="7">Week</button>
                            <button class="chart-period-option" data-days="14">2 Weeks</button>
                            <button class="chart-period-option" data-days="30">Month</button>
                        </div>
                    </div>
                </div>
                
                <!-- Key Insights Cards -->
                <div class="apple-insights-container">
                    <!-- Recovery Trend Insight -->
                    <div class="apple-insight-card neutral">
                        <div class="apple-insight-title">Recovery Trend</div>
                        <div class="apple-insight-value neutral">
                            {{ selected_record.get('recovery_score')|round if selected_record is mapping and selected_record.get('recovery_score') is not none else selected_record.recovery_score|round if not selected_record is mapping and selected_record.recovery_score is not none else "–" }}
                            <!-- Simplified trend indicator -->
                            <span class="apple-trend-indicator flat"><i class="fas fa-minus me-1"></i> Trend</span>
                        </div>
                        <p class="apple-insight-description">
                            No recovery data available for today.
                        </p>
                    </div>
                    
                    <!-- Mood Trend Insight -->
                    <div class="apple-insight-card positive">
                        <div class="apple-insight-title">Mood State</div>
                        <div class="apple-insight-value positive">
                            {{ selected_record.get('mood_rating') if selected_record is mapping and selected_record.get('mood_rating') is not none else selected_record.mood_rating if not selected_record is mapping and selected_record.mood_rating is not none else "–" }}
                            <!-- Simplified trend indicator -->
                            <span class="apple-trend-indicator flat"><i class="fas fa-minus me-1"></i> Trend</span>
                        </div>
                        <p class="apple-insight-description">
                            Your mood affects your overall wellness significantly.
                        </p>
                    </div>
                    
                    <!-- Strain-Recovery Balance Insight -->
                    <div class="apple-insight-card neutral">
                        <div class="apple-insight-title">Strain Balance</div>
                        <div class="apple-insight-value neutral">
                            <!-- Simplified balance value -->
                            <span>–</span>
                        </div>
                        <p class="apple-insight-description">
                            Balance data unavailable. Check strain and recovery metrics.
                        </p>
                    </div>
                </div>
                
                <!-- Chart Toggle Buttons -->
                <div class="apple-chart-toggle">
                    <button class="apple-chart-toggle-btn active" data-chart-type="metrics">Health Metrics</button>
                    <button class="apple-chart-toggle-btn" data-chart-type="burnout">Burnout Risk</button>
                </div>
                
                <!-- Simplified Visualizations -->
                {% if time_series %}
                <div class="apple-chart-container">
                    <div id="apple-metrics-chart" class="metrics-simplified-chart"></div>
                </div>
                <div class="apple-chart-legend">
                    <div class="apple-legend-item">
                        <span class="apple-legend-color" style="background-color: #28a745;"></span>
                        <span>Recovery</span>
                    </div>
                    <div class="apple-legend-item">
                        <span class="apple-legend-color" style="background-color: #4361ee;"></span>
                        <span>Mood</span>
                    </div>
                    <div class="apple-legend-item">
                        <span class="apple-legend-color" style="background-color: #6f42c1;"></span>
                        <span>Strain</span>
                    </div>
                    <div class="apple-legend-item">
                        <span class="apple-legend-color" style="background-color: #dc3545;"></span>
                        <span>Burnout Risk</span>
                    </div>
                </div>
                {% else %}
                <div class="no-data-container">
                    <i class="fas fa-chart-line no-data-icon"></i>
                    <p>Not enough data to display the chart.<br>Add mood data for multiple days to see trends.</p>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Right Column - Burnout Risk & Insights -->
        <div class="col-lg-5">
            <!-- Apple-style Burnout Risk Card -->
            <div class="burnout-risk-card mb-4">
                <div class="apple-burnout-header">
                    <div class="apple-burnout-title">
                        <h2><i class="fas fa-shield-alt"></i> Burnout Risk</h2>
                        <p class="apple-burnout-subtitle">Your personal risk assessment for {{ selected_date.strftime('%A, %b %d') if not selected_date is string else selected_date }}</p>
                    </div>
                    <div class="tooltip-icon" data-bs-toggle="tooltip" data-bs-html="true" 
                         title="<div class='p-2'>Calculated from your recovery scores, mood ratings, HRV, sleep quality, and strain-recovery balance over time</div>">
                        <i class="fas fa-info-circle"></i>
                    </div>
                </div>
                
                <div class="apple-risk-summary">
                    <div class="apple-risk-gauge" style="--risk-degree: {% if burnout_risk is not none %}{{ burnout_risk * 1.8 }}deg{% else %}0deg{% endif %}">
                        <div class="apple-risk-value">{{ burnout_risk|round if burnout_risk is not none else "0" }}</div>
                    </div>
                    
                    <div class="apple-risk-details">
                        <div class="apple-risk-level {% if burnout_risk is not none and burnout_risk < 33 %}low{% elif burnout_risk is not none and burnout_risk < 66 %}medium{% else %}high{% endif %}">
                            {% if burnout_risk is not none and burnout_risk < 33 %}
                            Low Risk
                            {% elif burnout_risk is not none and burnout_risk < 66 %}
                            Moderate Risk
                            {% elif burnout_risk is not none %}
                            High Risk
                            {% else %}
                            No Risk Data
                            {% endif %}
                        </div>
                        
                        <p class="apple-risk-description">
                            {% if burnout_risk is not none and burnout_risk < 33 %}
                            You're currently at low risk for burnout. Continue your healthy habits and monitor your metrics regularly.
                            {% elif burnout_risk is not none and burnout_risk < 66 %}
                            Your burnout risk is moderate. Consider adding stress-reducing activities and more recovery time to your schedule.
                            {% elif burnout_risk is not none %}
                            You're at high risk for burnout. Prioritize rest, stress management, and consider speaking with a healthcare professional.
                            {% else %}
                            Add more data to get an accurate burnout risk assessment. Track your mood and integrate with WHOOP.
                            {% endif %}
                        </p>
                    </div>
                </div>
                
                <div class="apple-risk-factors">
                    <h3 class="apple-risk-factors-title">Contributing Factors</h3>
                    
                    <div class="apple-risk-factor">
                        <div class="apple-rf-label">Recovery</div>
                        <div class="apple-rf-bar-container">
                            <div class="apple-rf-bar" style="width: 25%"></div>
                        </div>
                        <div class="apple-rf-value">25%</div>
                    </div>
                    
                    <div class="apple-risk-factor">
                        <div class="apple-rf-label">Mood</div>
                        <div class="apple-rf-bar-container">
                            <div class="apple-rf-bar" style="width: 30%; background-color: #4361ee;"></div>
                        </div>
                        <div class="apple-rf-value">30%</div>
                    </div>
                    
                    <div class="apple-risk-factor">
                        <div class="apple-rf-label">HRV</div>
                        <div class="apple-rf-bar-container">
                            <div class="apple-rf-bar" style="width: 15%; background-color: #6f42c1;"></div>
                        </div>
                        <div class="apple-rf-value">15%</div>
                    </div>
                    
                    <div class="apple-risk-factor">
                        <div class="apple-rf-label">Sleep Quality</div>
                        <div class="apple-rf-bar-container">
                            <div class="apple-rf-bar" style="width: 15%; background-color: #20c997;"></div>
                        </div>
                        <div class="apple-rf-value">15%</div>
                    </div>
                    
                    <div class="apple-risk-factor">
                        <div class="apple-rf-label">Strain Balance</div>
                        <div class="apple-rf-bar-container">
                            <div class="apple-rf-bar" style="width: 15%; background-color: #fd7e14;"></div>
                        </div>
                        <div class="apple-rf-value">15%</div>
                    </div>
                </div>
            </div>
            
            <!-- Apple-style AI Insights Card -->
            <div class="insights-card mb-4">
                <div class="apple-insights-header">
                    <div class="apple-insights-title">
                        <h2><i class="fas fa-brain"></i> AI Insights</h2>
                        <p class="apple-insights-subtitle">Personalized recommendations for your wellbeing</p>
                    </div>
                    <div class="apple-new-badge">
                        <i class="fas fa-star"></i> New
                    </div>
                </div>
                
                <div id="ai-insights-preview">
                    <p class="apple-insights-intro">Our AI analyzes your health patterns to provide personalized insights and actionable recommendations to help you prevent burnout and optimize your wellbeing.</p>
                    
                    <button id="load-insights-btn" class="apple-insights-button">
                        <i class="fas fa-lightbulb"></i>
                        <span id="insights-btn-text">Generate Insights</span>
                    </button>
                    
                    <div id="insights-content" style="display: none;">
                        <div id="loading-insights" class="apple-insights-loading">
                            <div class="spinner"></div>
                            <p>Analyzing your health patterns...</p>
                        </div>
                        <div id="insights-result" class="apple-insights-result"></div>
                    </div>
                    
                    <div class="apple-insights-footer">
                        <a href="{{ url_for('core.ai_insights') }}" class="apple-insights-more">
                            View advanced analysis <i class="fas fa-chevron-right"></i>
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Recent Data Card -->
            <div class="recent-data-card">
                <div class="recent-data-header">
                    <h2>Recent History</h2>
                    <div class="filter-dropdown">
                        <button class="btn btn-sm btn-light">
                            Last 7 days <i class="fas fa-caret-down ms-1"></i>
                        </button>
                    </div>
                </div>
                
                <div class="data-timeline">
                    {% for record in records[:7] %}
                    <div class="timeline-item">
                        <div class="ti-date">
                            {% if record.date is string %}
                                {{ record.date }}
                            {% else %}
                                {{ record.date.strftime('%a, %b %d') }}
                            {% endif %}
                        </div>
                        
                        <div class="ti-metrics">
                            <div class="ti-metric">
                                <span class="ti-label">Recovery</span>
                                <span class="ti-value 
                                    {% if record is mapping and record.get('recovery_score') is not none %}
                                        {% if record.get('recovery_score') > 66 %}text-success
                                        {% elif record.get('recovery_score') > 33 %}text-warning
                                        {% else %}text-danger{% endif %}
                                    {% elif not record is mapping and record.recovery_score is not none %}
                                        {% if record.recovery_score > 66 %}text-success
                                        {% elif record.recovery_score > 33 %}text-warning
                                        {% else %}text-danger{% endif %}
                                    {% endif %}">
                                    {% if record is mapping %}
                                        {{ record.get('recovery_score')|round if record.get('recovery_score') is not none else "–" }}
                                    {% else %}
                                        {{ record.recovery_score|round if record.recovery_score is not none else "–" }}
                                    {% endif %}
                                </span>
                            </div>
                            
                            <div class="ti-metric">
                                <span class="ti-label">Mood</span>
                                <span class="ti-value
                                    {% if record is mapping and record.get('mood_rating') is not none %}
                                        {% if record.get('mood_rating') > 6 %}text-success
                                        {% elif record.get('mood_rating') > 3 %}text-warning
                                        {% else %}text-danger{% endif %}
                                    {% elif not record is mapping and record.mood_rating is not none %}
                                        {% if record.mood_rating > 6 %}text-success
                                        {% elif record.mood_rating > 3 %}text-warning
                                        {% else %}text-danger{% endif %}
                                    {% endif %}">
                                    {% if record is mapping %}
                                        {{ record.get('mood_rating') if record.get('mood_rating') is not none else "–" }}
                                    {% else %}
                                        {{ record.mood_rating if record.mood_rating is not none else "–" }}
                                    {% endif %}
                                </span>
                            </div>
                            
                            <div class="ti-metric">
                                <span class="ti-label">Risk</span>
                                <span class="ti-value
                                    {% if record is mapping and record.get('burnout_current') is not none %}
                                        {% if record.get('burnout_current') < 33 %}text-success
                                        {% elif record.get('burnout_current') < 66 %}text-warning
                                        {% else %}text-danger{% endif %}
                                    {% elif not record is mapping and record.burnout_current is not none %}
                                        {% if record.burnout_current < 33 %}text-success
                                        {% elif record.burnout_current < 66 %}text-warning
                                        {% else %}text-danger{% endif %}
                                    {% endif %}">
                                    {% if record is mapping %}
                                        {{ record.get('burnout_current')|round if record.get('burnout_current') is not none else "–" }}%
                                    {% else %}
                                        {{ record.burnout_current|round if record.burnout_current is not none else "–" }}%
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                        
                        <div class="ti-link">
                            {% if record.date is string %}
                                <a href="{{ url_for('core.dashboard', selected_date=record.date) }}" class="ti-view-btn">
                                    <i class="fas fa-eye"></i>
                                </a>
                            {% else %}
                                <a href="{{ url_for('core.dashboard', selected_date=record.date.strftime('%Y-%m-%d')) }}" class="ti-view-btn">
                                    <i class="fas fa-eye"></i>
                                </a>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    {% else %}
    <!-- No Data State -->
    <div class="no-data-page">
        <div class="no-data-content">
            <div class="no-data-icon">
                <i class="fas fa-chart-area"></i>
            </div>
            <h2>No data available for 
                {% if selected_date is string %}
                    {{ selected_date }}
                {% else %}
                    {{ selected_date.strftime('%A, %B %d, %Y') }}
                {% endif %}
            </h2>
            <p>Start tracking your health metrics to monitor burnout risk.</p>
            <div class="no-data-actions">
                <a href="{{ url_for('core.input_mood', input_date=selected_date.strftime('%Y-%m-%d') if not selected_date is string else selected_date) }}" class="btn btn-primary">
                    <i class="fas fa-plus-circle me-2"></i> Add Mood for This Day
                </a>
                <a href="{{ url_for('core.settings') }}" class="btn btn-light">
                    <i class="fas fa-cog me-1"></i> Settings
                </a>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    // Browser detection to help with debugging
    function detectBrowser() {
        const userAgent = navigator.userAgent;
        let browserName;
        
        if (userAgent.match(/chrome|chromium|crios/i)) {
            browserName = "Chrome";
        } else if (userAgent.match(/firefox|fxios/i)) {
            browserName = "Firefox";
        } else if (userAgent.match(/safari/i)) {
            browserName = "Safari";
        } else if (userAgent.match(/opr\//i)) {
            browserName = "Opera";
        } else if (userAgent.match(/edg/i)) {
            browserName = "Edge";
        } else {
            browserName = "Unknown";
        }
        
        return browserName;
    }
    
    // Log browser information to help with debugging
    console.log("Browser: " + detectBrowser());
    console.log("User Agent: " + navigator.userAgent);
    
    // Main document ready handler - contains all JavaScript initialization
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Bootstrap tooltips
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
        
        // Apple-style AI Insights handler
        const loadInsightsBtn = document.getElementById('load-insights-btn');
        const insightsContent = document.getElementById('insights-content');
        const loadingInsights = document.getElementById('loading-insights');
        const insightsResult = document.getElementById('insights-result');
        const insightsBtnText = document.getElementById('insights-btn-text');
        
        if (loadInsightsBtn) {
            loadInsightsBtn.addEventListener('click', function() {
                // Show the insights section and loading spinner
                insightsContent.style.display = 'block';
                loadingInsights.style.display = 'flex';
                insightsResult.style.display = 'none';
                insightsBtnText.textContent = 'Analyzing...';
                loadInsightsBtn.disabled = true;
                
                // Make AJAX request to get insights
                fetch('/api/insights', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({})
                })
                .then(response => response.json())
                .then(data => {
                    // Hide loading spinner
                    loadingInsights.style.display = 'none';
                    
                    // Show results
                    console.log("API response:", data); // Debug: Log the response for browser console
                    
                    if (data.success) {
                        try {
                            // Parse markdown content
                            const htmlContent = marked.parse(data.insight);
                            insightsResult.innerHTML = htmlContent;
                            insightsResult.style.display = 'block';
                            insightsBtnText.textContent = 'Refresh Insights';
                        } catch (parseError) {
                            console.error("Error parsing markdown:", parseError);
                            // Fallback to raw display in case of parsing error
                            insightsResult.innerHTML = `<div><pre>${data.insight}</pre></div>`;
                            insightsResult.style.display = 'block';
                            insightsBtnText.textContent = 'Refresh Insights';
                        }
                    } else {
                        console.warn("API error:", data.error);
                        insightsResult.innerHTML = `
                            <div style="padding: 1rem; color: #856404; background-color: #fff3cd; border-radius: 8px;">
                                <i class="fas fa-exclamation-triangle" style="margin-right: 0.5rem;"></i>
                                ${data.error || 'Could not generate insights. Try adding more data.'}
                            </div>
                        `;
                        insightsResult.style.display = 'block';
                        insightsBtnText.textContent = 'Try Again';
                    }
                    
                    // Re-enable button
                    loadInsightsBtn.disabled = false;
                })
                .catch(error => {
                    // Handle errors
                    loadingInsights.style.display = 'none';
                    insightsResult.innerHTML = `
                        <div style="padding: 1rem; color: #721c24; background-color: #f8d7da; border-radius: 8px;">
                            <i class="fas fa-exclamation-circle" style="margin-right: 0.5rem;"></i>
                            Error: ${error.message || 'Connection issue. Please try again.'}
                        </div>
                    `;
                    insightsResult.style.display = 'block';
                    loadInsightsBtn.disabled = false;
                    insightsBtnText.textContent = 'Try Again';
                });
            });
        }
    
        // Apple-style Chart Initialization
        {% if time_series %}
        try {
            const timeSeriesData = {{ time_series|safe }};
            if (timeSeriesData && timeSeriesData.data && timeSeriesData.layout) {
                // Create simplified Apple-style charts
                const appleMetricsChart = document.getElementById('apple-metrics-chart');
                
                // Extract data from original time series
                let dates = [];
                let recoveryScores = [];
                let moodRatings = [];
                let strainValues = [];
                let burnoutRisks = [];
                
                // Find the data in the original plot
                timeSeriesData.data.forEach(trace => {
                    if (trace.name === "Recovery Score") {
                        dates = [...trace.x];
                        recoveryScores = [...trace.y];
                    } else if (trace.name === "Mood Rating") {
                        moodRatings = [...trace.y];
                    } else if (trace.name === "Strain (0-21)") {
                        strainValues = [...trace.y];
                    } else if (trace.name === "Burnout Risk") {
                        burnoutRisks = [...trace.y];
                    }
                });
                
                // Scale mood values from 0-100 for better comparison (they're already scaled in the data)
                
                // Create simplified layout
                const appleLayout = {
                    margin: {t: 20, b: 30, l: 40, r: 30},
                    font: {family: 'SF Pro Display, -apple-system, BlinkMacSystemFont, Inter, sans-serif'},
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    xaxis: {
                        showgrid: false,
                        zeroline: false,
                        showline: true,
                        linecolor: 'rgba(0,0,0,0.1)',
                        tickformat: '%b %d'
                    },
                    yaxis: {
                        range: [0, 100],
                        showgrid: true,
                        gridcolor: 'rgba(0,0,0,0.05)',
                        zeroline: false,
                        showticklabels: true,
                        fixedrange: true
                    },
                    showlegend: false,
                    hovermode: 'x unified'
                };
                
                // Create metrics data
                const metricsPlotData = [
                    {
                        x: dates,
                        y: recoveryScores,
                        name: 'Recovery',
                        type: 'scatter',
                        mode: 'lines',
                        line: { 
                            color: '#28a745', 
                            width: 3,
                            shape: 'spline'
                        },
                        hovertemplate: '<b>Recovery:</b> %{y:.0f}<extra></extra>'
                    },
                    {
                        x: dates,
                        y: moodRatings,
                        name: 'Mood',
                        type: 'scatter',
                        mode: 'lines',
                        line: { 
                            color: '#4361ee', 
                            width: 3,
                            shape: 'spline'
                        },
                        hovertemplate: '<b>Mood:</b> %{y:.0f}<extra></extra>'
                    },
                    {
                        x: dates,
                        y: strainValues.map(v => v ? v * (100/21) : null), // Scale 0-21 to 0-100
                        name: 'Strain',
                        type: 'scatter',
                        mode: 'lines',
                        line: { 
                            color: '#6f42c1', 
                            width: 2,
                            shape: 'spline',
                            dash: 'dot'
                        },
                        hovertemplate: '<b>Strain:</b> %{y:.0f}%<extra></extra>'
                    }
                ];
                
                // Burnout risk data
                const burnoutPlotData = [
                    {
                        x: dates,
                        y: burnoutRisks,
                        name: 'Burnout Risk',
                        type: 'scatter',
                        mode: 'lines',
                        fill: 'tozeroy',
                        line: { 
                            color: '#dc3545', 
                            width: 2,
                            shape: 'spline'
                        },
                        fillcolor: 'rgba(220, 53, 69, 0.2)',
                        hovertemplate: '<b>Burnout Risk:</b> %{y:.0f}%<extra></extra>'
                    }
                ];
                
                // Add risk zones in the background
                const riskZones = [
                    {
                        type: 'rect',
                        x0: dates[0],
                        x1: dates[dates.length - 1],
                        y0: 0,
                        y1: 33,
                        fillcolor: 'rgba(40, 167, 69, 0.05)',
                        line: { width: 0 },
                        layer: 'below'
                    },
                    {
                        type: 'rect',
                        x0: dates[0],
                        x1: dates[dates.length - 1],
                        y0: 33,
                        y1: 66,
                        fillcolor: 'rgba(255, 193, 7, 0.05)',
                        line: { width: 0 },
                        layer: 'below'
                    },
                    {
                        type: 'rect',
                        x0: dates[0],
                        x1: dates[dates.length - 1],
                        y0: 66,
                        y1: 100,
                        fillcolor: 'rgba(220, 53, 69, 0.05)',
                        line: { width: 0 },
                        layer: 'below'
                    }
                ];
                
                // Add risk zones to burnout layout
                const burnoutLayout = JSON.parse(JSON.stringify(appleLayout));
                burnoutLayout.shapes = riskZones;
                
                // Initialize with metrics chart first
                Plotly.newPlot('apple-metrics-chart', metricsPlotData, appleLayout, {
                    displayModeBar: false,
                    responsive: true
                });
                
                // Initialize chart toggle buttons
                const toggleButtons = document.querySelectorAll('.apple-chart-toggle-btn');
                toggleButtons.forEach(btn => {
                    btn.addEventListener('click', function() {
                        // Remove active class from all buttons
                        toggleButtons.forEach(b => b.classList.remove('active'));
                        // Add active class to clicked button
                        this.classList.add('active');
                        
                        // Switch between charts
                        const chartType = this.getAttribute('data-chart-type');
                        if (chartType === 'metrics') {
                            Plotly.react('apple-metrics-chart', metricsPlotData, appleLayout, {
                                displayModeBar: false,
                                responsive: true
                            });
                        } else if (chartType === 'burnout') {
                            Plotly.react('apple-metrics-chart', burnoutPlotData, burnoutLayout, {
                                displayModeBar: false,
                                responsive: true
                            });
                        }
                    });
                });
                
                // Initialize period selector
                const periodButtons = document.querySelectorAll('.chart-period-option');
                periodButtons.forEach(btn => {
                    btn.addEventListener('click', function() {
                        // Remove active class from all buttons
                        periodButtons.forEach(b => b.classList.remove('active'));
                        // Add active class to clicked button
                        this.classList.add('active');
                        
                        // Get selected days
                        const days = parseInt(this.getAttribute('data-days'));
                        
                        // Filter data based on selected period
                        const cutoffIndex = Math.max(0, dates.length - days);
                        
                        // Update metrics chart data
                        const filteredMetricsData = metricsPlotData.map(trace => {
                            return {
                                ...trace,
                                x: dates.slice(cutoffIndex),
                                y: trace.y.slice(cutoffIndex)
                            };
                        });
                        
                        // Update burnout chart data
                        const filteredBurnoutData = burnoutPlotData.map(trace => {
                            return {
                                ...trace,
                                x: dates.slice(cutoffIndex),
                                y: trace.y.slice(cutoffIndex)
                            };
                        });
                        
                        // Update risk zones
                        const updatedRiskZones = riskZones.map(zone => {
                            return {
                                ...zone,
                                x0: dates[cutoffIndex],
                                x1: dates[dates.length - 1]
                            };
                        });
                        
                        // Update burnout layout
                        const updatedBurnoutLayout = JSON.parse(JSON.stringify(burnoutLayout));
                        updatedBurnoutLayout.shapes = updatedRiskZones;
                        
                        // Update currently visible chart
                        const activeChart = document.querySelector('.apple-chart-toggle-btn.active').getAttribute('data-chart-type');
                        if (activeChart === 'metrics') {
                            Plotly.react('apple-metrics-chart', filteredMetricsData, appleLayout, {
                                displayModeBar: false,
                                responsive: true
                            });
                        } else {
                            Plotly.react('apple-metrics-chart', filteredBurnoutData, updatedBurnoutLayout, {
                                displayModeBar: false,
                                responsive: true
                            });
                        }
                    });
                });
            }
        } catch (err) {
            console.error("Error plotting Apple-style chart:", err);
            document.getElementById('apple-metrics-chart').innerHTML = `
                <div class="chart-error">
                    <i class="fas fa-exclamation-circle"></i>
                    <p>Error loading chart</p>
                </div>`;
        }
        {% endif %}
        
        // Custom Calendar Implementation
        const datePickerToggle = document.getElementById('date-picker-toggle');
        const calendarPopup = document.getElementById('custom-calendar');
        const daysContainer = document.getElementById('calendar-days');
        const monthYearDisplay = document.getElementById('month-year-display');
        const prevMonthBtn = document.getElementById('prev-month');
        const nextMonthBtn = document.getElementById('next-month');
        const goToTodayBtn = document.getElementById('go-to-today');
        const currentDateDisplay = document.getElementById('current-date-display');
        
        // Calendar state
        let currentMonth;
        let currentYear;
        let selectedDate;
        let calendarData = {};
        
        // Initialize with the selected date
        const selectedDateStr = "{% if selected_date is string %}{{ selected_date }}{% else %}{{ selected_date.strftime('%Y-%m-%d') }}{% endif %}";
        selectedDate = new Date(selectedDateStr);
        currentMonth = selectedDate.getMonth();
        currentYear = selectedDate.getFullYear();
        
        // Toggle calendar visibility - with improved event handling
        datePickerToggle.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // Force toggle instead of checking current state
            if (calendarPopup.style.display === 'block') {
                hideCalendar();
            } else {
                showCalendar();
            }
        });
        
        // Function to show calendar
        function showCalendar() {
            // Set display explicitly
            calendarPopup.style.display = 'block';
            
            // Render and fetch data
            renderCalendar(currentMonth, currentYear);
            fetchCalendarData(currentYear, currentMonth + 1);
            
            // Add outside click handler with a slight delay to avoid immediate triggering
            setTimeout(() => {
                document.addEventListener('click', closeCalendarOnClickOutside);
            }, 100);
        }
        
        // Function to hide calendar
        function hideCalendar() {
            calendarPopup.style.display = 'none';
            document.removeEventListener('click', closeCalendarOnClickOutside);
        }
        
        // Function to handle clicks outside the calendar
        function closeCalendarOnClickOutside(e) {
            if (!calendarPopup.contains(e.target) && !datePickerToggle.contains(e.target)) {
                hideCalendar();
            }
        }
        
        // Navigation buttons
        prevMonthBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar(currentMonth, currentYear);
            fetchCalendarData(currentYear, currentMonth + 1);
        });
        
        nextMonthBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar(currentMonth, currentYear);
            fetchCalendarData(currentYear, currentMonth + 1);
        });
        
        goToTodayBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            const today = new Date();
            currentMonth = today.getMonth();
            currentYear = today.getFullYear();
            renderCalendar(currentMonth, currentYear);
            fetchCalendarData(currentYear, currentMonth + 1);
        });
        
        // Fetch calendar data from the API
        function fetchCalendarData(year, month) {
            const url = `/calendar_data/${year}/${month}`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    // Store data indexed by date
                    calendarData = {};
                    data.forEach(item => {
                        calendarData[item.date] = item;
                    });
                    // Update calendar with risk levels
                    updateCalendarRiskLevels();
                })
                .catch(error => console.error('Error fetching calendar data:', error));
        }
        
        // Update calendar days with risk levels
        function updateCalendarRiskLevels() {
            const dayElements = document.querySelectorAll('.calendar-day');
            dayElements.forEach(dayEl => {
                const dateStr = dayEl.dataset.date;
                if (dateStr && calendarData[dateStr]) {
                    const data = calendarData[dateStr];
                    
                    // Remove any existing risk classes
                    dayEl.classList.remove('calendar-day-risk-low', 'calendar-day-risk-medium', 'calendar-day-risk-high');
                    
                    // Add appropriate risk class
                    if (data.risk_level === 'low') {
                        dayEl.classList.add('calendar-day-risk-low');
                    } else if (data.risk_level === 'medium') {
                        dayEl.classList.add('calendar-day-risk-medium');
                    } else if (data.risk_level === 'high') {
                        dayEl.classList.add('calendar-day-risk-high');
                    }
                    
                    // Mark as having data
                    dayEl.classList.add('calendar-day-with-data');
                    
                    // Add tooltip with detailed info
                    let tooltipContent = `Date: ${dateStr}\n`;
                    if (data.burnout_risk !== null) tooltipContent += `Burnout Risk: ${data.burnout_risk.toFixed(1)}%\n`;
                    if (data.recovery_score !== null) tooltipContent += `Recovery: ${data.recovery_score.toFixed(1)}\n`;
                    if (data.mood_rating !== null) tooltipContent += `Mood: ${data.mood_rating}/10\n`;
                    
                    dayEl.title = tooltipContent;
                }
            });
        }
        
        // Render calendar for a specific month/year
        function renderCalendar(month, year) {
            // Update header
            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"];
            monthYearDisplay.textContent = `${monthNames[month]} ${year}`;
            
            // Clear previous days
            daysContainer.innerHTML = '';
            
            // Get the first day of the month
            const firstDay = new Date(year, month, 1).getDay();
            
            // Get the number of days in the month
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Create padding for first week
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.classList.add('calendar-day', 'calendar-day-disabled');
                daysContainer.appendChild(emptyDay);
            }
            
            // Create days of the month
            const today = new Date();
            const currentDate = new Date();
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.classList.add('calendar-day');
                dayElement.textContent = day;
                
                // Create date string for this day
                const dateObj = new Date(year, month, day);
                const dateStr = dateObj.toISOString().split('T')[0]; // YYYY-MM-DD format
                dayElement.dataset.date = dateStr;
                
                // Mark today
                if (dateObj.getDate() === today.getDate() && 
                    dateObj.getMonth() === today.getMonth() && 
                    dateObj.getFullYear() === today.getFullYear()) {
                    dayElement.classList.add('calendar-day-today');
                }
                
                // Mark selected date
                if (dateObj.getDate() === selectedDate.getDate() && 
                    dateObj.getMonth() === selectedDate.getMonth() && 
                    dateObj.getFullYear() === selectedDate.getFullYear()) {
                    dayElement.classList.add('calendar-day-selected');
                }
                
                // Disable future dates
                if (dateObj > currentDate) {
                    dayElement.classList.add('calendar-day-disabled');
                } else {
                    // Improved click handler for valid dates
                    dayElement.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // Show loading state
                        this.classList.add('calendar-day-loading');
                        
                        // Navigate to the date
                        const targetUrl = "{{ url_for('core.dashboard') }}/" + dateStr;
                        window.location.href = targetUrl;
                    });
                }
                
                daysContainer.appendChild(dayElement);
            }
        }
    });
</script>
{% endblock %}