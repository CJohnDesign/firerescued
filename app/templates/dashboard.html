{% extends "layout.html" %}

{% block content %}
<div class="dashboard-container">
    <!-- Top Navigation Bar with Date Selector -->
    <div class="date-nav-bar mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div class="nav-date-controls">
                {% if has_prev %}
                <a href="{{ url_for('core.dashboard', selected_date=prev_date) }}" class="btn btn-icon btn-light">
                    <i class="fas fa-chevron-left"></i>
                </a>
                {% else %}
                <button class="btn btn-icon btn-light" disabled>
                    <i class="fas fa-chevron-left"></i>
                </button>
                {% endif %}
                
                <div class="date-picker-wrapper mx-2">
                    <button type="button" id="date-picker-toggle" class="btn btn-outline-primary date-selector-btn">
                        <i class="fas fa-calendar-alt me-2"></i>
                        <span id="current-date-display">
                            {% if selected_date is string %}
                                {{ selected_date }}
                            {% else %}
                                {{ selected_date.strftime('%b %d, %Y') }}
                            {% endif %}
                        </span>
                        <i class="fas fa-caret-down ms-2"></i>
                    </button>
                    
                    <!-- Calendar Popup (Hidden by Default) -->
                    <div id="custom-calendar" class="custom-calendar-popup">
                        <div class="calendar-header">
                            <button type="button" id="prev-month" class="calendar-nav-btn"><i class="fas fa-chevron-left"></i></button>
                            <div id="month-year-display"></div>
                            <button type="button" id="next-month" class="calendar-nav-btn"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <div class="calendar-weekdays">
                            <div>Su</div><div>Mo</div><div>Tu</div><div>We</div><div>Th</div><div>Fr</div><div>Sa</div>
                        </div>
                        <div id="calendar-days" class="calendar-days"></div>
                        <div class="calendar-footer">
                            <div class="calendar-legend">
                                <span class="legend-item"><span class="dot dot-green"></span> Low Risk</span>
                                <span class="legend-item"><span class="dot dot-yellow"></span> Medium Risk</span>
                                <span class="legend-item"><span class="dot dot-red"></span> High Risk</span>
                                <span class="legend-item"><span class="dot dot-gray"></span> No Data</span>
                            </div>
                            <button type="button" id="go-to-today" class="btn btn-sm btn-outline-primary">Today</button>
                        </div>
                    </div>
                </div>
                
                {% if has_next %}
                <a href="{{ url_for('core.dashboard', selected_date=next_date) }}" class="btn btn-icon btn-light">
                    <i class="fas fa-chevron-right"></i>
                </a>
                {% else %}
                <button class="btn btn-icon btn-light" disabled>
                    <i class="fas fa-chevron-right"></i>
                </button>
                {% endif %}
                
                <a href="{{ url_for('core.dashboard') }}" class="btn btn-light ms-2">
                    <i class="fas fa-calendar-day me-1"></i> Today
                </a>
            </div>
            
            <!-- Right-side Actions -->
            <div class="nav-actions">
                {% if selected_record is mapping and selected_record.get('mood_rating') is not none or not selected_record is mapping and selected_record.mood_rating is not none %}
                <div class="btn-group">
                    <a href="{{ url_for('core.input_mood', input_date=selected_date.strftime('%Y-%m-%d') if not selected_date is string else selected_date) }}" 
                       class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-edit me-1"></i> Update Mood
                    </a>
                </div>
                {% else %}
                <a href="{{ url_for('core.input_mood', input_date=selected_date.strftime('%Y-%m-%d') if not selected_date is string else selected_date) }}" 
                   class="btn btn-primary btn-sm">
                    <i class="fas fa-plus-circle me-1"></i> Add Mood
                </a>
                {% endif %}
                
                <a href="{{ url_for('core.settings') }}" class="btn btn-light btn-sm ms-2">
                    <i class="fas fa-cog"></i>
                </a>
            </div>
        </div>
    </div>

    {% if selected_record %}
    <!-- Main Dashboard Content -->
    <div class="row g-4">
        <!-- Left Column - Key Metrics -->
        <div class="col-lg-7">
            <!-- Apple-style AI Insights Card -->
            <div class="insights-card mb-4">
                <div class="apple-insights-header">
                    <div class="apple-insights-title">
                        <h2><i class="fas fa-brain"></i> AI Insights</h2>
                        <p class="apple-insights-subtitle">Personalized recommendations for your wellbeing</p>
                    </div>
                    <div class="apple-new-badge">
                        <i class="fas fa-star"></i> New
                    </div>
                </div>
                
                <div id="ai-insights-preview">
                    <p class="apple-insights-intro">Our AI analyzes your health patterns to provide personalized insights and actionable recommendations to help you prevent burnout and optimize your wellbeing.</p>
                    
                    <button id="load-insights-btn" class="apple-insights-button">
                        <i class="fas fa-lightbulb"></i>
                        <span id="insights-btn-text">Generate Insights</span>
                    </button>
                    
                    <div id="insights-content" style="display: none;">
                        <div id="loading-insights" class="apple-insights-loading">
                            <div class="spinner"></div>
                            <p>Analyzing your health patterns...</p>
                        </div>
                        <div id="insights-result" class="apple-insights-result"></div>
                    </div>
                    
                    <div class="apple-insights-footer">
                        <a href="{{ url_for('core.ai_insights') }}" class="apple-insights-more">
                            View advanced analysis <i class="fas fa-chevron-right"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Column - Burnout Risk & Insights -->
        <div class="col-lg-5">
            <!-- Apple-style Burnout Risk Card -->
            <div class="burnout-risk-card mb-4">
                <div class="apple-burnout-header">
                    <div class="apple-burnout-title">
                        <h2><i class="fas fa-shield-alt"></i> Burnout Risk</h2>
                        <p class="apple-burnout-subtitle">Your personal risk assessment for {{ selected_date.strftime('%A, %b %d') if not selected_date is string else selected_date }}</p>
                    </div>
                    <div class="tooltip-icon" data-bs-toggle="tooltip" data-bs-html="true" 
                         title="<div class='p-2'>Calculated from your recovery scores, HRV, sleep quality, and strain-recovery balance over time</div>">
                        <i class="fas fa-info-circle"></i>
                    </div>
                </div>
                
                <div class="apple-risk-summary">
                    <div class="apple-risk-gauge" 
                        {% if burnout_risk is not none and burnout_risk < 33 %}
                            style="--gauge-color: var(--bs-success); --risk-percent: {{ burnout_risk }}%;"
                        {% elif burnout_risk is not none and burnout_risk < 66 %}
                            style="--gauge-color: var(--bs-warning); --risk-percent: {{ burnout_risk }}%;"
                        {% else %}
                            style="--gauge-color: var(--bs-danger); --risk-percent: {{ burnout_risk }}%;"
                        {% endif %}
                    >
                        <div class="apple-risk-value">
                            {{ burnout_risk|round if burnout_risk is not none else "0" }}
                        </div>
                    </div>
                    
                    <div class="apple-risk-details">
                        <div class="apple-risk-level {% if burnout_risk is not none and burnout_risk < 33 %}low{% elif burnout_risk is not none and burnout_risk < 66 %}medium{% else %}high{% endif %}">
                            {% if burnout_risk is not none and burnout_risk < 33 %}
                            Low Risk
                            {% elif burnout_risk is not none and burnout_risk < 66 %}
                            Moderate Risk
                            {% elif burnout_risk is not none %}
                            High Risk
                            {% else %}
                            No Risk Data
                            {% endif %}
                        </div>
                        
                        <p class="apple-risk-description">
                            {% if burnout_risk is not none and burnout_risk < 33 %}
                            You're currently at low risk for burnout. Continue your healthy habits and monitor your metrics regularly.
                            {% elif burnout_risk is not none and burnout_risk < 66 %}
                            Your burnout risk is moderate. Consider adding stress-reducing activities and more recovery time to your schedule.
                            {% elif burnout_risk is not none %}
                            You're at high risk for burnout. Prioritize rest, stress management, and consider speaking with a healthcare professional.
                            {% else %}
                            Add more data to get an accurate burnout risk assessment. Integrate with WHOOP for comprehensive analysis.
                            {% endif %}
                        </p>
                    </div>
                </div>
                
                <div class="apple-risk-factors">
                    <h3 class="apple-risk-factors-title">Contributing Factors</h3>
                    
                    <div class="apple-risk-factor">
                        <div class="apple-rf-label">Recovery</div>
                        <div class="apple-rf-bar-container">
                            <div class="apple-rf-bar" style="width: 40%"></div>
                        </div>
                        <div class="apple-rf-value">40%</div>
                    </div>
                    
                    <div class="apple-risk-factor">
                        <div class="apple-rf-label">Sleep Quality</div>
                        <div class="apple-rf-bar-container">
                            <div class="apple-rf-bar" style="width: 30%; background-color: #20c997;"></div>
                        </div>
                        <div class="apple-rf-value">30%</div>
                    </div>
                    
                    <div class="apple-risk-factor">
                        <div class="apple-rf-label">HRV</div>
                        <div class="apple-rf-bar-container">
                            <div class="apple-rf-bar" style="width: 15%; background-color: #6f42c1;"></div>
                        </div>
                        <div class="apple-rf-value">15%</div>
                    </div>
                    
                    <div class="apple-risk-factor">
                        <div class="apple-rf-label">Strain Balance</div>
                        <div class="apple-rf-bar-container">
                            <div class="apple-rf-bar" style="width: 15%; background-color: #fd7e14;"></div>
                        </div>
                        <div class="apple-rf-value">15%</div>
                    </div>
                </div>
            </div>
            
            <!-- Recent Data Card -->
            <div class="recent-data-card">
                <div class="recent-data-header">
                    <h2>Recent History</h2>
                    <div class="filter-dropdown">
                        <button class="btn btn-sm btn-light">
                            Last 7 days <i class="fas fa-caret-down ms-1"></i>
                        </button>
                    </div>
                </div>
                
                <div class="data-timeline">
                    {% for record in records[:7] %}
                    <div class="timeline-item">
                        <div class="ti-date">
                            {% if record.date is string %}
                                {{ record.date }}
                            {% else %}
                                {{ record.date.strftime('%a, %b %d') }}
                            {% endif %}
                        </div>
                        
                        <div class="ti-metrics">
                            <div class="ti-metric">
                                <span class="ti-label">Recovery</span>
                                <span class="ti-value 
                                    {% if record is mapping and record.get('recovery_score') is not none %}
                                        {% if record.get('recovery_score') > 66 %}text-success
                                        {% elif record.get('recovery_score') > 33 %}text-warning
                                        {% else %}text-danger{% endif %}
                                    {% elif not record is mapping and record.recovery_score is not none %}
                                        {% if record.recovery_score > 66 %}text-success
                                        {% elif record.recovery_score > 33 %}text-warning
                                        {% else %}text-danger{% endif %}
                                    {% endif %}">
                                    {% if record is mapping %}
                                        {{ record.get('recovery_score')|round if record.get('recovery_score') is not none else "–" }}
                                    {% else %}
                                        {{ record.recovery_score|round if record.recovery_score is not none else "–" }}
                                    {% endif %}
                                </span>
                            </div>
                            
                            <div class="ti-metric">
                                <span class="ti-label">Mood</span>
                                <span class="ti-value
                                    {% if record is mapping and record.get('mood_rating') is not none %}
                                        {% if record.get('mood_rating') > 6 %}text-success
                                        {% elif record.get('mood_rating') > 3 %}text-warning
                                        {% else %}text-danger{% endif %}
                                    {% elif not record is mapping and record.mood_rating is not none %}
                                        {% if record.mood_rating > 6 %}text-success
                                        {% elif record.mood_rating > 3 %}text-warning
                                        {% else %}text-danger{% endif %}
                                    {% endif %}">
                                    {% if record is mapping %}
                                        {{ record.get('mood_rating') if record.get('mood_rating') is not none else "–" }}
                                    {% else %}
                                        {{ record.mood_rating if record.mood_rating is not none else "–" }}
                                    {% endif %}
                                </span>
                            </div>
                            
                            <div class="ti-metric">
                                <span class="ti-label">Risk</span>
                                <span class="ti-value
                                    {% if record is mapping and record.get('burnout_current') is not none %}
                                        {% if record.get('burnout_current') < 33 %}text-success
                                        {% elif record.get('burnout_current') < 66 %}text-warning
                                        {% else %}text-danger{% endif %}
                                    {% elif not record is mapping and record.burnout_current is not none %}
                                        {% if record.burnout_current < 33 %}text-success
                                        {% elif record.burnout_current < 66 %}text-warning
                                        {% else %}text-danger{% endif %}
                                    {% endif %}">
                                    {% if record is mapping %}
                                        {{ record.get('burnout_current')|round if record.get('burnout_current') is not none else "–" }}%
                                    {% else %}
                                        {{ record.burnout_current|round if record.burnout_current is not none else "–" }}%
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                        
                        <div class="ti-link">
                            {% if record.date is string %}
                                <a href="{{ url_for('core.dashboard', selected_date=record.date) }}" class="ti-view-btn">
                                    <i class="fas fa-eye"></i>
                                </a>
                            {% else %}
                                <a href="{{ url_for('core.dashboard', selected_date=record.date.strftime('%Y-%m-%d')) }}" class="ti-view-btn">
                                    <i class="fas fa-eye"></i>
                                </a>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    {% else %}
    <!-- No Data State -->
    <div class="no-data-page">
        <div class="no-data-content">
            <div class="no-data-icon">
                <i class="fas fa-chart-area"></i>
            </div>
            <h2>No data available for 
                {% if selected_date is string %}
                    {{ selected_date }}
                {% else %}
                    {{ selected_date.strftime('%A, %B %d, %Y') }}
                {% endif %}
            </h2>
            <p>Start tracking your health metrics to monitor burnout risk.</p>
            <div class="no-data-actions">
                <a href="{{ url_for('core.input_mood', input_date=selected_date.strftime('%Y-%m-%d') if not selected_date is string else selected_date) }}" class="btn btn-primary">
                    <i class="fas fa-plus-circle me-2"></i> Add Mood for This Day
                </a>
                <a href="{{ url_for('core.settings') }}" class="btn btn-light">
                    <i class="fas fa-cog me-1"></i> Settings
                </a>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

<!-- Calendar functionality combined into main script in the scripts block -->

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    // Calendar functionality - Define all necessary functions in the global scope
    // Global variables for calendar
    var currentMonth = new Date().getMonth();
    var currentYear = new Date().getFullYear();
    // Parse selected date from the page
    var selectedDateStr = "{% if selected_date is string %}{{ selected_date }}{% else %}{{ selected_date.strftime('%Y-%m-%d') }}{% endif %}";
    var selectedDate = new Date(selectedDateStr);
    // Fallback to today if invalid date
    if (isNaN(selectedDate.getTime())) {
        selectedDate = new Date();
    }
    // Initialize month/year based on selected date
    currentMonth = selectedDate.getMonth();
    currentYear = selectedDate.getFullYear();
    var calendarData = {};
    
    // Main toggle function
    function toggleCalendar(event) {
        var calendarPopup = document.getElementById('custom-calendar');
        if (calendarPopup.style.display === 'block') {
            calendarPopup.style.display = 'none';
        } else {
            calendarPopup.style.display = 'block';
            
            // Initialize calendar content directly here
            var daysContainer = document.getElementById('calendar-days');
            var monthYearDisplay = document.getElementById('month-year-display');
            
            // Render the calendar directly
            if (daysContainer) {
                renderCalendar();
                fetchCalendarData();
            }
            
            // Add document click handler to close calendar when clicking outside
            setTimeout(function() {
                document.addEventListener('click', function outsideClickHandler(e) {
                    if (!calendarPopup.contains(e.target) && 
                        e.target.id !== 'date-picker-toggle' && 
                        !e.target.closest('#date-picker-toggle')) {
                        calendarPopup.style.display = 'none';
                        document.removeEventListener('click', outsideClickHandler);
                    }
                });
            }, 10);
        }
        
        // Explicitly prevent default and stop propagation
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        return false;
    }
    
    // Calendar render function
    function renderCalendar() {
        var monthYearDisplay = document.getElementById('month-year-display');
        var daysContainer = document.getElementById('calendar-days');
        
        if (!monthYearDisplay || !daysContainer) return;
        
        var monthNames = ["January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December"];
            
        // Update header
        monthYearDisplay.textContent = monthNames[currentMonth] + " " + currentYear;
        
        // Clear days
        daysContainer.innerHTML = '';
        
        // Get first day of month and number of days
        var firstDay = new Date(currentYear, currentMonth, 1).getDay();
        var daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        
        // Add empty cells for days before first of month
        for (var i = 0; i < firstDay; i++) {
            var emptyDay = document.createElement('div');
            emptyDay.className = 'calendar-day calendar-day-disabled';
            daysContainer.appendChild(emptyDay);
        }
        
        // Add days of month
        var today = new Date();
        
        for (var day = 1; day <= daysInMonth; day++) {
            var dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';
            dayElement.textContent = day;
            
            // Create date string
            var dateObj = new Date(currentYear, currentMonth, day);
            var dateStr = dateObj.toISOString().split('T')[0];
            dayElement.dataset.date = dateStr;
            
            // Mark today
            if (dateObj.getDate() === today.getDate() && 
                dateObj.getMonth() === today.getMonth() && 
                dateObj.getFullYear() === today.getFullYear()) {
                dayElement.classList.add('calendar-day-today');
            }
            
            // Mark selected date
            if (dateObj.getDate() === selectedDate.getDate() && 
                dateObj.getMonth() === selectedDate.getMonth() && 
                dateObj.getFullYear() === selectedDate.getFullYear()) {
                dayElement.classList.add('calendar-day-selected');
            }
            
            // Disable future dates
            if (dateObj > today) {
                dayElement.classList.add('calendar-day-disabled');
            } else {
                // Click handler - use closure to capture date value
                (function(date) {
                    dayElement.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        window.location.href = "{{ url_for('core.dashboard') }}/" + date;
                    });
                })(dateStr);
            }
            
            daysContainer.appendChild(dayElement);
        }
    }
    
    // Fetch data for calendar
    function fetchCalendarData() {
        fetch('/api/calendar_data/' + currentYear + '/' + (currentMonth + 1))
            .then(function(response) { return response.json(); })
            .then(function(data) {
                // Process data
                calendarData = {};
                data.forEach(function(item) {
                    calendarData[item.date] = item;
                });
                
                // Update calendar with risk levels
                updateCalendarRiskLevels();
            })
            .catch(function(error) {
                console.error('Error fetching calendar data:', error);
            });
    }
    
    // Update calendar days with risk levels
    function updateCalendarRiskLevels() {
        var dayElements = document.querySelectorAll('.calendar-day');
        dayElements.forEach(function(dayEl) {
            var dateStr = dayEl.dataset.date;
            if (dateStr && calendarData[dateStr]) {
                var data = calendarData[dateStr];
                
                // Remove existing classes
                dayEl.classList.remove('calendar-day-risk-low', 'calendar-day-risk-medium', 'calendar-day-risk-high');
                
                // Add appropriate class
                if (data.burnout_risk !== null) {
                    if (data.burnout_risk < 33) {
                        dayEl.classList.add('calendar-day-risk-low');
                    } else if (data.burnout_risk < 66) {
                        dayEl.classList.add('calendar-day-risk-medium');
                    } else {
                        dayEl.classList.add('calendar-day-risk-high');
                    }
                }
                
                // Add tooltip
                var tooltip = 'Date: ' + dateStr;
                if (data.burnout_risk !== null) tooltip += '\nBurnout Risk: ' + data.burnout_risk.toFixed(1) + '%';
                if (data.recovery_score !== null) tooltip += '\nRecovery: ' + data.recovery_score.toFixed(1);
                if (data.mood_rating !== null) tooltip += '\nMood: ' + data.mood_rating + '/10';
                
                dayEl.title = tooltip;
            }
        });
    }
    
    // Browser detection to help with debugging
    function detectBrowser() {
        const userAgent = navigator.userAgent;
        let browserName;
        
        if (userAgent.match(/chrome|chromium|crios/i)) {
            browserName = "Chrome";
        } else if (userAgent.match(/firefox|fxios/i)) {
            browserName = "Firefox";
        } else if (userAgent.match(/safari/i)) {
            browserName = "Safari";
        } else if (userAgent.match(/opr\//i)) {
            browserName = "Opera";
        } else if (userAgent.match(/edg/i)) {
            browserName = "Edge";
        } else {
            browserName = "Unknown";
        }
        
        return browserName;
    }
    
    // Log browser information to help with debugging
    console.log("Browser: " + detectBrowser());
    console.log("User Agent: " + navigator.userAgent);
    
    // Main document ready handler - contains all JavaScript initialization
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Bootstrap tooltips
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
        
        // Calendar date picker toggle button
        const datePickerToggle = document.getElementById('date-picker-toggle');
        const calendarPopup = document.getElementById('custom-calendar');
        
        if (datePickerToggle && calendarPopup) {
            // Add click event to toggle calendar visibility
            datePickerToggle.addEventListener('click', function(e) {
                toggleCalendar(e);
            });
            
            // Prevent clicks inside calendar from closing it
            calendarPopup.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        }
        
        // Initialize calendar navigation buttons
        const prevMonthBtn = document.getElementById('prev-month');
        const nextMonthBtn = document.getElementById('next-month');
        const goToTodayBtn = document.getElementById('go-to-today');
        
        if (prevMonthBtn) {
            prevMonthBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                currentMonth--;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                }
                renderCalendar();
                fetchCalendarData();
            });
        }
        
        if (nextMonthBtn) {
            nextMonthBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                currentMonth++;
                if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                renderCalendar();
                fetchCalendarData();
            });
        }
        
        if (goToTodayBtn) {
            goToTodayBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                // Redirect to today's dashboard
                window.location.href = "{{ url_for('core.dashboard') }}";
            });
        }
        
        // Apple-style AI Insights handler
        const loadInsightsBtn = document.getElementById('load-insights-btn');
        const insightsContent = document.getElementById('insights-content');
        const loadingInsights = document.getElementById('loading-insights');
        const insightsResult = document.getElementById('insights-result');
        const insightsBtnText = document.getElementById('insights-btn-text');
        
        if (loadInsightsBtn) {
            loadInsightsBtn.addEventListener('click', function() {
                // Show the insights section and loading spinner
                insightsContent.style.display = 'block';
                loadingInsights.style.display = 'flex';
                insightsResult.style.display = 'none';
                insightsBtnText.textContent = 'Analyzing...';
                loadInsightsBtn.disabled = true;
                
                // Make AJAX request to get insights
                fetch('/api/insights', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({})
                })
                .then(response => response.json())
                .then(data => {
                    // Hide loading spinner
                    loadingInsights.style.display = 'none';
                    
                    // Show results
                    console.log("API response:", data); // Debug: Log the response for browser console
                    
                    if (data.success) {
                        try {
                            // Parse markdown content
                            const htmlContent = marked.parse(data.insight);
                            insightsResult.innerHTML = htmlContent;
                            insightsResult.style.display = 'block';
                            insightsBtnText.textContent = 'Refresh Insights';
                        } catch (parseError) {
                            console.error("Error parsing markdown:", parseError);
                            // Fallback to raw display in case of parsing error
                            insightsResult.innerHTML = `<div><pre>${data.insight}</pre></div>`;
                            insightsResult.style.display = 'block';
                            insightsBtnText.textContent = 'Refresh Insights';
                        }
                    } else {
                        console.warn("API error:", data.error);
                        insightsResult.innerHTML = `
                            <div style="padding: 1rem; color: #856404; background-color: #fff3cd; border-radius: 8px;">
                                <i class="fas fa-exclamation-triangle" style="margin-right: 0.5rem;"></i>
                                ${data.error || 'Could not generate insights. Try adding more data.'}
                            </div>
                        `;
                        insightsResult.style.display = 'block';
                        insightsBtnText.textContent = 'Try Again';
                    }
                    
                    // Re-enable button
                    loadInsightsBtn.disabled = false;
                })
                .catch(error => {
                    // Handle errors
                    loadingInsights.style.display = 'none';
                    insightsResult.innerHTML = `
                        <div style="padding: 1rem; color: #721c24; background-color: #f8d7da; border-radius: 8px;">
                            <i class="fas fa-exclamation-circle" style="margin-right: 0.5rem;"></i>
                            Error: ${error.message || 'Connection issue. Please try again.'}
                        </div>
                    `;
                    insightsResult.style.display = 'block';
                    loadInsightsBtn.disabled = false;
                    insightsBtnText.textContent = 'Try Again';
                });
            });
        }
    
        // Apple-style Chart Initialization
        (function() {
            // Get chart data from a data attribute that will be populated by Jinja
            var chartContainer = document.getElementById('apple-metrics-chart-container');
            if (!chartContainer) return;
            
            var timeSeriesData = null;
            try {
                var dataStr = chartContainer.getAttribute('data-chart');
                if (dataStr) {
                    timeSeriesData = JSON.parse(dataStr);
                }
                
                if (timeSeriesData && timeSeriesData.data && timeSeriesData.layout) {
                    // Create simplified Apple-style charts
                    var appleMetricsChart = document.getElementById('apple-metrics-chart');
                    if (!appleMetricsChart) return;
                    
                    // Initialize chart with Plotly
                    Plotly.newPlot('apple-metrics-chart', 
                        timeSeriesData.data, 
                        timeSeriesData.layout, 
                        {displayModeBar: false, responsive: true}
                    );
                    
                    // Add chart toggle and period selector functionality
                    initializeChartControls(timeSeriesData);
                }
            } catch (err) {
                console.error("Error plotting Apple-style chart:", err);
                var chartElement = document.getElementById('apple-metrics-chart');
                if (chartElement) {
                    chartElement.innerHTML = `
                        <div class="chart-error">
                            <i class="fas fa-exclamation-circle"></i>
                            <p>Error loading chart</p>
                        </div>`;
                }
            }
            
            // Function to initialize chart controls
            function initializeChartControls(chartData) {
                // Add chart toggle functionality
                const toggleButtons = document.querySelectorAll('.apple-chart-toggle-btn');
                if (toggleButtons) {
                    toggleButtons.forEach(btn => {
                        btn.addEventListener('click', function() {
                            toggleButtons.forEach(b => b.classList.remove('active'));
                            this.classList.add('active');
                            updateChartByType(this.getAttribute('data-chart-type'), chartData);
                        });
                    });
                }
                
                // Add period selector functionality
                const periodButtons = document.querySelectorAll('.chart-period-option');
                if (periodButtons) {
                    periodButtons.forEach(btn => {
                        btn.addEventListener('click', function() {
                            periodButtons.forEach(b => b.classList.remove('active'));
                            this.classList.add('active');
                            updateChartByPeriod(parseInt(this.getAttribute('data-days')), chartData);
                        });
                    });
                }
            }
            
            // Functions for chart updates based on type and period
            function updateChartByType(chartType, chartData) {
                console.log("Updating chart type:", chartType);
                // Implementation would depend on the actual chart data structure
            }
            
            function updateChartByPeriod(days, chartData) {
                console.log("Updating chart period:", days);
                // Implementation would depend on the actual chart data structure
            }
        })();
        
        // ===== CALENDAR IMPLEMENTATION =====
        // Calendar functionality is already implemented in the global scope
        // and event listeners are attached above
    });
</script>
{% endblock %}

{% block chart_data %}
<!-- This block is used to inject chart data -->
{% if time_series %}
<div id="apple-metrics-chart-container" data-chart='{{ time_series|safe }}' style="display:none;"></div>
{% endif %}
{% endblock %}
