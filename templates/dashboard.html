{% extends "layout.html" %}

{% block content %}
<h1 class="mb-4">Burnout Predictor Dashboard</h1>

<!-- Authentication Status -->
{% if whoop_authenticated %}
<div class="alert alert-success mb-4">
    <i class="fas fa-check-circle"></i> Connected to Whoop
</div>
{% else %}
<div class="alert alert-warning mb-4">
    <i class="fas fa-exclamation-triangle"></i> Not connected to Whoop
    <a href="{{ url_for('auth') }}" class="btn btn-sm btn-info ml-2">Connect Now</a>
</div>
{% endif %}

<!-- Day Navigation and Data Card -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    {% if has_prev %}
                    <a href="{{ url_for('dashboard', selected_date=prev_date) }}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-chevron-left"></i> Previous Day
                    </a>
                    {% else %}
                    <button class="btn btn-sm btn-outline-secondary" disabled>
                        <i class="fas fa-chevron-left"></i> Previous Day
                    </button>
                    {% endif %}
                    
                    <strong class="mx-3">{{ selected_date.strftime('%A, %B %d, %Y') }}</strong>
                    
                    {% if has_next %}
                    <a href="{{ url_for('dashboard', selected_date=next_date) }}" class="btn btn-sm btn-outline-primary">
                        Next Day <i class="fas fa-chevron-right"></i>
                    </a>
                    {% else %}
                    <button class="btn btn-sm btn-outline-secondary" disabled>
                        Next Day <i class="fas fa-chevron-right"></i>
                    </button>
                    {% endif %}
                </div>
                <div class="date-picker-wrapper">
                    <button id="date-picker-toggle" class="btn btn-sm btn-primary" type="button">
                        <i class="fas fa-calendar-alt"></i> <span id="current-date-display">{{ selected_date.strftime('%b %d, %Y') }}</span>
                    </button>
                    <div id="custom-calendar" class="custom-calendar-popup">
                        <div class="calendar-header">
                            <button id="prev-month" class="calendar-nav-btn"><i class="fas fa-chevron-left"></i></button>
                            <div id="month-year-display"></div>
                            <button id="next-month" class="calendar-nav-btn"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <div class="calendar-weekdays">
                            <div>Su</div><div>Mo</div><div>Tu</div><div>We</div><div>Th</div><div>Fr</div><div>Sa</div>
                        </div>
                        <div id="calendar-days" class="calendar-days"></div>
                        <div class="calendar-footer">
                            <div class="calendar-legend">
                                <span class="legend-item"><span class="dot dot-green"></span> Low Risk</span>
                                <span class="legend-item"><span class="dot dot-yellow"></span> Medium Risk</span>
                                <span class="legend-item"><span class="dot dot-red"></span> High Risk</span>
                                <span class="legend-item"><span class="dot dot-gray"></span> No Data</span>
                            </div>
                            <button id="go-to-today" class="btn btn-sm btn-outline-primary">Today</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body">
                {% if selected_record %}
                <!-- First row - Core metrics -->
                <div class="row mb-4">
                    <div class="col-lg-3 col-md-6 mb-3 mb-lg-0">
                        <div class="metric-card">
                            <h6>Recovery Score</h6>
                            <div class="metric-value {% if selected_record.recovery_score is not none and selected_record.recovery_score > 66 %}text-success{% elif selected_record.recovery_score is not none and selected_record.recovery_score > 33 %}text-warning{% elif selected_record.recovery_score is not none %}text-danger{% else %}text-muted{% endif %}">
                                {{ selected_record.recovery_score|round(1) if selected_record.recovery_score is not none else "N/A" }}
                            </div>
                            <div class="metric-badge">
                                {% if selected_record.recovery_score is not none %}
                                    {% if selected_record.recovery_score > 66 %}
                                    <span class="badge bg-success">Green</span>
                                    {% elif selected_record.recovery_score > 33 %}
                                    <span class="badge bg-warning text-dark">Yellow</span>
                                    {% else %}
                                    <span class="badge bg-danger">Red</span>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3 mb-lg-0">
                        <div class="metric-card">
                            <h6>Mood Rating</h6>
                            <div class="metric-value {% if selected_record.mood_rating is not none and selected_record.mood_rating > 6 %}text-success{% elif selected_record.mood_rating is not none and selected_record.mood_rating > 3 %}text-warning{% elif selected_record.mood_rating is not none %}text-danger{% else %}text-muted{% endif %}">
                                {{ selected_record.mood_rating if selected_record.mood_rating is not none else "N/A" }}
                                <span class="fs-6 text-muted">/10</span>
                            </div>
                            <div class="metric-badge">
                                {% if selected_record.mood_rating is not none %}
                                    {% if selected_record.mood_rating > 6 %}
                                    <span class="badge bg-success">Good</span>
                                    {% elif selected_record.mood_rating > 3 %}
                                    <span class="badge bg-warning text-dark">Neutral</span>
                                    {% else %}
                                    <span class="badge bg-danger">Poor</span>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3 mb-lg-0">
                        <div class="metric-card">
                            <h6>Daily Strain</h6>
                            <div class="metric-value {% if selected_record.strain is not none and selected_record.strain < 9 %}text-success{% elif selected_record.strain is not none and selected_record.strain < 14 %}text-warning{% elif selected_record.strain is not none %}text-danger{% else %}text-muted{% endif %}">
                                {{ selected_record.strain|round(1) if selected_record.strain is not none else "N/A" }}
                                <span class="fs-6 text-muted">/21</span>
                            </div>
                            <div class="metric-badge">
                                {% if selected_record.strain is not none %}
                                    {% if selected_record.strain < 9 %}
                                    <span class="badge bg-success">Light</span>
                                    {% elif selected_record.strain < 14 %}
                                    <span class="badge bg-warning text-dark">Moderate</span>
                                    {% elif selected_record.strain < 18 %}
                                    <span class="badge bg-danger">High</span>
                                    {% else %}
                                    <span class="badge bg-dark">All Out</span>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-3 col-md-6">
                        <div class="metric-card highlight-card">
                            <h6>Burnout Risk</h6>
                            <div class="metric-value {% if burnout_risk is not none and burnout_risk < 33 %}text-success{% elif burnout_risk is not none and burnout_risk < 66 %}text-warning{% elif burnout_risk is not none %}text-danger{% else %}text-muted{% endif %}">
                                {{ burnout_risk|round(1) if burnout_risk is not none else "N/A" }}{% if burnout_risk is not none %}%{% endif %}
                            </div>
                            <div class="burnout-badge">
                                {% if burnout_risk is not none %}
                                    {% if burnout_risk < 33 %}
                                    <span class="badge bg-success p-2">Low Risk</span>
                                    {% elif burnout_risk < 66 %}
                                    <span class="badge bg-warning text-dark p-2">Moderate Risk</span>
                                    {% else %}
                                    <span class="badge bg-danger p-2">High Risk</span>
                                    {% endif %}
                                    
                                    {% if selected_record.burnout_trend %}
                                        {% if selected_record.burnout_trend > 5 %}
                                        <span class="badge bg-danger mt-1"><i class="fas fa-arrow-up"></i> Worsening</span>
                                        {% elif selected_record.burnout_trend < -5 %}
                                        <span class="badge bg-success mt-1"><i class="fas fa-arrow-down"></i> Improving</span>
                                        {% endif %}
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Second row - Additional metrics -->
                <div class="row">
                    <div class="col-md-3 col-6 mb-3">
                        <div class="small-metric-card">
                            <div class="small-metric-title">HRV</div>
                            <div class="small-metric-value">
                                {{ selected_record.hrv|round(1) if selected_record.hrv is not none else "—" }}
                                {% if selected_record.hrv is not none %}<span class="small-unit">ms</span>{% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6 mb-3">
                        <div class="small-metric-card">
                            <div class="small-metric-title">Resting HR</div>
                            <div class="small-metric-value">
                                {{ selected_record.resting_hr|round if selected_record.resting_hr is not none else "—" }}
                                {% if selected_record.resting_hr is not none %}<span class="small-unit">bpm</span>{% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6 mb-3">
                        <div class="small-metric-card">
                            <div class="small-metric-title">Sleep Quality</div>
                            <div class="small-metric-value">
                                {{ selected_record.sleep_quality|round if selected_record.sleep_quality is not none else "—" }}
                                {% if selected_record.sleep_quality is not none %}<span class="small-unit">%</span>{% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6 mb-3">
                        <div class="small-metric-card">
                            <div class="small-metric-title">Sleep Time</div>
                            <div class="small-metric-value">
                                {% if selected_record.total_sleep_time is not none %}
                                    {{ (selected_record.total_sleep_time/60)|round(1) }}<span class="small-unit">hrs</span>
                                {% else %}
                                    —
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-12">
                        {% if not selected_record.mood_rating %}
                        <a href="{{ url_for('input_mood', input_date=selected_date.strftime('%Y-%m-%d')) }}" class="btn btn-primary">Input Mood for {{ selected_date.strftime('%b %d') }}</a>
                        {% elif selected_record.mood_rating %}
                        <a href="{{ url_for('input_mood', input_date=selected_date.strftime('%Y-%m-%d')) }}" class="btn btn-outline-primary">Update Mood</a>
                        {% endif %}
                        
                        <form method="post" action="{{ url_for('manual_fetch_data') }}" class="d-inline">
                            <input type="hidden" name="date" value="{{ selected_date.strftime('%Y-%m-%d') }}">
                            <button type="submit" class="btn btn-secondary">Fetch Whoop Data</button>
                        </form>
                        
                        <a href="{{ url_for('auth') }}" class="btn btn-info">Authenticate with Whoop</a>
                    </div>
                </div>
                {% else %}
                <p>No data available for {{ selected_date.strftime('%A, %B %d, %Y') }}.</p>
                <a href="{{ url_for('input_mood', input_date=selected_date.strftime('%Y-%m-%d')) }}" class="btn btn-primary">Input Mood for {{ selected_date.strftime('%b %d') }}</a>
                <form method="post" action="{{ url_for('manual_fetch_data') }}" class="d-inline">
                    <input type="hidden" name="date" value="{{ selected_date.strftime('%Y-%m-%d') }}">
                    <button type="submit" class="btn btn-secondary">Fetch Whoop Data</button>
                </form>
                <a href="{{ url_for('auth') }}" class="btn btn-info">Authenticate with Whoop</a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Time Series Chart -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5>Metrics Over Time</h5>
            </div>
            <div class="card-body">
                {% if time_series %}
                <div id="time-series-chart" class="chart-container"></div>
                {% else %}
                <p>Not enough data to display the time series chart.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Correlation Analysis -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>Correlation Analysis</h5>
            </div>
            <div class="card-body">
                {% if correlation_text %}
                <p>{{ correlation_text }}</p>
                {% else %}
                <p>Not enough data points for correlation analysis.</p>
                {% endif %}
                
                {% if correlation_plot %}
                <div id="correlation-chart" class="chart-container"></div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Burnout Risk Explanation -->
    <div class="col-md-6 mt-4 mt-md-0">
        <div class="card">
            <div class="card-header">
                <h5>Understanding Burnout Risk</h5>
            </div>
            <div class="card-body">
                <p>Your burnout risk score uses an advanced algorithm that analyzes:</p>
                <ul>
                    <li><strong>Recovery Trend (25%)</strong>: Patterns in your recovery scores over time</li>
                    <li><strong>Mood Assessment (30%)</strong>: Your subjective feelings and trend over time</li>
                    <li><strong>HRV Analysis (15%)</strong>: Heart rate variability as a stress biomarker</li>
                    <li><strong>Sleep Quality (15%)</strong>: Sleep efficiency, consistency and stages</li>
                    <li><strong>Strain-Recovery Balance (15%)</strong>: Optimal vs excessive physical stress</li>
                </ul>
                <p class="mt-2"><strong>Key Feature:</strong> This model analyzes time patterns (previous days), not just today's metrics.</p>
                <div class="d-flex justify-content-between mt-3">
                    <span class="badge bg-success p-2">Low Risk (0-33%)</span>
                    <span class="badge bg-warning text-dark p-2">Moderate Risk (34-66%)</span>
                    <span class="badge bg-danger p-2">High Risk (67-100%)</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>Recent Data</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Recovery</th>
                                <th>Mood</th>
                                <th>Burnout Risk</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for record in records %}
                            <tr>
                                <td>{{ record.date.strftime('%Y-%m-%d') }}</td>
                                <td>{{ record.recovery_score|round(1) if record.recovery_score else "N/A" }}</td>
                                <td>{{ record.mood_rating if record.mood_rating else "N/A" }}</td>
                                <td>
                                    {% if record.recovery_score %}
                                        {{ "%.1f"|format(get_burnout_risk_score(record)) }}%
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    {% if time_series %}
    const timeSeriesData = {{ time_series|safe }};
    Plotly.newPlot('time-series-chart', timeSeriesData.data, timeSeriesData.layout);
    {% endif %}
    
    {% if correlation_plot %}
    const correlationData = {{ correlation_plot|safe }};
    Plotly.newPlot('correlation-chart', correlationData.data, correlationData.layout);
    {% endif %}
    
    // Custom Calendar Implementation
    document.addEventListener('DOMContentLoaded', function() {
        const datePickerToggle = document.getElementById('date-picker-toggle');
        const calendarPopup = document.getElementById('custom-calendar');
        const daysContainer = document.getElementById('calendar-days');
        const monthYearDisplay = document.getElementById('month-year-display');
        const prevMonthBtn = document.getElementById('prev-month');
        const nextMonthBtn = document.getElementById('next-month');
        const goToTodayBtn = document.getElementById('go-to-today');
        const currentDateDisplay = document.getElementById('current-date-display');
        
        // Calendar state
        let currentMonth;
        let currentYear;
        let selectedDate;
        let calendarData = {};
        
        // Initialize with the selected date
        const selectedDateStr = "{{ selected_date.strftime('%Y-%m-%d') }}";
        selectedDate = new Date(selectedDateStr);
        currentMonth = selectedDate.getMonth();
        currentYear = selectedDate.getFullYear();
        
        // Toggle calendar visibility - with improved event handling
        datePickerToggle.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // Force toggle instead of checking current state
            if (calendarPopup.style.display === 'block') {
                hideCalendar();
            } else {
                showCalendar();
            }
        });
        
        // Function to show calendar
        function showCalendar() {
            // Set display explicitly
            calendarPopup.style.display = 'block';
            
            // Render and fetch data
            renderCalendar(currentMonth, currentYear);
            fetchCalendarData(currentYear, currentMonth + 1);
            
            // Add outside click handler with a slight delay to avoid immediate triggering
            setTimeout(() => {
                document.addEventListener('click', closeCalendarOnClickOutside);
            }, 100);
        }
        
        // Function to hide calendar
        function hideCalendar() {
            calendarPopup.style.display = 'none';
            document.removeEventListener('click', closeCalendarOnClickOutside);
        }
        
        // Function to handle clicks outside the calendar
        function closeCalendarOnClickOutside(e) {
            if (!calendarPopup.contains(e.target) && !datePickerToggle.contains(e.target)) {
                hideCalendar();
            }
        }
        
        // Navigation buttons
        prevMonthBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar(currentMonth, currentYear);
            fetchCalendarData(currentYear, currentMonth + 1);
        });
        
        nextMonthBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar(currentMonth, currentYear);
            fetchCalendarData(currentYear, currentMonth + 1);
        });
        
        goToTodayBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            const today = new Date();
            currentMonth = today.getMonth();
            currentYear = today.getFullYear();
            renderCalendar(currentMonth, currentYear);
            fetchCalendarData(currentYear, currentMonth + 1);
        });
        
        // Fetch calendar data from the API
        function fetchCalendarData(year, month) {
            const url = `/calendar_data/${year}/${month}`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    // Store data indexed by date
                    calendarData = {};
                    data.forEach(item => {
                        calendarData[item.date] = item;
                    });
                    // Update calendar with risk levels
                    updateCalendarRiskLevels();
                })
                .catch(error => console.error('Error fetching calendar data:', error));
        }
        
        // Update calendar days with risk levels
        function updateCalendarRiskLevels() {
            const dayElements = document.querySelectorAll('.calendar-day');
            dayElements.forEach(dayEl => {
                const dateStr = dayEl.dataset.date;
                if (dateStr && calendarData[dateStr]) {
                    const data = calendarData[dateStr];
                    
                    // Remove any existing risk classes
                    dayEl.classList.remove('calendar-day-risk-low', 'calendar-day-risk-medium', 'calendar-day-risk-high');
                    
                    // Add appropriate risk class
                    if (data.risk_level === 'low') {
                        dayEl.classList.add('calendar-day-risk-low');
                    } else if (data.risk_level === 'medium') {
                        dayEl.classList.add('calendar-day-risk-medium');
                    } else if (data.risk_level === 'high') {
                        dayEl.classList.add('calendar-day-risk-high');
                    }
                    
                    // Mark as having data
                    dayEl.classList.add('calendar-day-with-data');
                    
                    // Add tooltip with detailed info
                    let tooltipContent = `Date: ${dateStr}\n`;
                    if (data.burnout_risk !== null) tooltipContent += `Burnout Risk: ${data.burnout_risk.toFixed(1)}%\n`;
                    if (data.recovery_score !== null) tooltipContent += `Recovery: ${data.recovery_score.toFixed(1)}\n`;
                    if (data.mood_rating !== null) tooltipContent += `Mood: ${data.mood_rating}/10\n`;
                    
                    dayEl.title = tooltipContent;
                }
            });
        }
        
        // Render calendar for a specific month/year
        function renderCalendar(month, year) {
            // Update header
            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"];
            monthYearDisplay.textContent = `${monthNames[month]} ${year}`;
            
            // Clear previous days
            daysContainer.innerHTML = '';
            
            // Get the first day of the month
            const firstDay = new Date(year, month, 1).getDay();
            
            // Get the number of days in the month
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Create padding for first week
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.classList.add('calendar-day', 'calendar-day-disabled');
                daysContainer.appendChild(emptyDay);
            }
            
            // Create days of the month
            const today = new Date();
            const currentDate = new Date();
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.classList.add('calendar-day');
                dayElement.textContent = day;
                
                // Create date string for this day
                const dateObj = new Date(year, month, day);
                const dateStr = dateObj.toISOString().split('T')[0]; // YYYY-MM-DD format
                dayElement.dataset.date = dateStr;
                
                // Mark today
                if (dateObj.getDate() === today.getDate() && 
                    dateObj.getMonth() === today.getMonth() && 
                    dateObj.getFullYear() === today.getFullYear()) {
                    dayElement.classList.add('calendar-day-today');
                }
                
                // Mark selected date
                if (dateObj.getDate() === selectedDate.getDate() && 
                    dateObj.getMonth() === selectedDate.getMonth() && 
                    dateObj.getFullYear() === selectedDate.getFullYear()) {
                    dayElement.classList.add('calendar-day-selected');
                }
                
                // Disable future dates
                if (dateObj > currentDate) {
                    dayElement.classList.add('calendar-day-disabled');
                } else {
                    // Improved click handler for valid dates
                    dayElement.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // Show loading state
                        this.classList.add('calendar-day-loading');
                        
                        // Navigate to the date
                        const targetUrl = "{{ url_for('dashboard') }}/" + dateStr;
                        window.location.href = targetUrl;
                    });
                }
                
                daysContainer.appendChild(dayElement);
            }
        }
    });
</script>
{% endblock %}